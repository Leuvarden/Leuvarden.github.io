<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Circles</title>
	<script type="text/javascript" src="phaser.min.js"></script>
</head>

<body>
	<div id="test"></div>

	<script type="text/javascript">
	var game = new Phaser.Game(1000, 560, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create });

let PIECE_WIDTH = 110,
	PIECE_HEIGHT = 110,
	BOARD_COLS,
	BOARD_ROWS,
	decipher;

let piecesGroup,
	piecesAmount,
	shuffledIndexArray = [];

function preload() {
	game.load.spritesheet("background", "assets/bg-playfair.jpg", PIECE_WIDTH, PIECE_HEIGHT);
	game.load.spritesheet("decipher", "assets/decipher-playfair.png");
	game.load.image('pigeon', 'assets/pigeon.jpg');
	game.load.bitmapFont('Fira', 'assets/fonts/fira-sans.png', 'assets/fonts/fira-sans.fnt');
	game.load.bitmapFont('Playfair', 'assets/fonts/playfair.png', 'assets/fonts/playfair.fnt');
}

function create() {
	game.stage.backgroundColor = '#f95732';

	title = game.add.bitmapText(game.world.centerX * 0.01, game.world.centerY * 0.01, 'Fira', 'LOST BATALLION\'S \nMESSAGE', 50);
	title.tint = 0x000000;

	textarea = game.add.graphics(0, 0);
	textarea.beginFill(0xffffff);
	textarea.drawRect(game.world.centerX * 0.01, game.world.centerY * 0.5, 420, game.world.height * 0.72);
	textarea.endFill();

	game.add.sprite(game.world.centerX * 0.4, game.world.centerY * 1.2, 'pigeon');

	let ciphered = 'Zbbqabmpmhsibuldeobqfqapoqu Uqsmylcsufopatwhtbtp lokmhbcbqqbkbioubdsovpoqt Ilsgabzasxqcpktuploy';
	cipheredText = game.add.bitmapText(game.world.centerX * 0.02, game.world.centerY * 0.52, 'Playfair', ciphered, 24);
	cipheredText.maxWidth = 400;
	cipheredText.tint = 0x000000;

	decipheredText = game.add.bitmapText(game.world.centerX * 0.02, game.world.centerY * 0.52, 'Playfair', 'We are along the road paralell to 276.4. Our own artillery is dropping a barrage directly on us. For heavens sake stop it.', 24);
	decipheredText.maxWidth = 400;
	decipheredText.tint = 0x000000;
	decipheredText.alpha = 0;
	prepareBoard();

	decipher = game.add.sprite(game.world.width-555, 5, 'decipher');
	decipher.alpha = 0;
}

function prepareBoard() {
	let piecesIndex = 0,
			i, j,
			piece;

	BOARD_COLS = 5;
	BOARD_ROWS = 5;

	piecesAmount = BOARD_COLS * BOARD_ROWS;
	shuffledIndexArray = createIndexArray();

	function createIndexArray() {
    let indexArray = [];
    for (var i = 0; i < piecesAmount; i++)  {
      indexArray.push(i);
    }
    return indexArray;
}

	piecesGroup = game.add.group();

	for (i = 0; i < BOARD_ROWS; i++) {
			for (j = 0; j < BOARD_COLS; j++)	{
					piece = piecesGroup.create(j * PIECE_WIDTH + game.world.width-500, i * PIECE_HEIGHT + 60, "background", shuffledIndexArray[piecesIndex]);
					piece.inputEnabled = true;
					piece.events.onInputDown.add(rotatePiece, this);
					piece.anchor.setTo(0.5, 0.5);
					piece.angle = getRandomAngle();
					piecesIndex++;
			}
	}

	function getRandomAngle() {
		let possiblePositions = [0, 90, -180, -90];
		let randomPosition = Math.floor(Math.random() * possiblePositions.length);
		return possiblePositions[randomPosition];
	}

	function rotatePiece(piece) {
		 if (isFinished() === true) {
		 	piece.angle = piece.angle;
	  } else {
			piece.angle = Math.round(piece.angle + 90);
			isFinished();
		}
	}

	function isFinished() {
		let isFinished = true;
    piecesGroup.children.forEach((piece) => {
        if (piece.angle !== 0) {
            isFinished = false;
            return;
        }
    });
    if (isFinished) {
				game.add.tween(piecesGroup).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true);
				game.add.tween(decipher).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true);
    }
		return isFinished;
	}
}
	</script>
</body>
</html>
