<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Pong</title>
	<script type="text/javascript" src="phaser.min.js"></script>
</head>

<body>
	<script type="text/javascript">
	var game = new Phaser.Game(640, 480, Phaser.AUTO, '', {preload: preload, create: create, update: update});


	let playerBet,
			compBet,
			ball,
			computerBetSpeed = 190;
			ballSpeed = 300;

	function preload() {
		game.load.image('ball', 'assets/ball.png');
		game.load.image('bet', 'assets/ledge.png');
		game.load.image('bg', 'assets/bg.jpg');
	}
	function create() {
		game.add.tileSprite(0, 0, 640, 480, 'bg');
		playerBet = createBet(game.world.centerX, 600);
    compBet = createBet(game.world.centerX, 20);

		ball = game.add.sprite(game.world.centerX, game.world.centerY, 'ball');
		game.physics.enable(ball);
		ball.anchor.setTo(0.5, 0.5);
		ball.body.collideWorldBounds = true;
		ball.body.bounce.setTo(1, 1);
		game.input.onDown.add(releaseBall, this);
	}

	var ballReleased = false;

	function releaseBall () {
		if (!ballReleased) {
			ball.body.velocity.x = ballSpeed;
			ball.body.velocity.y = ballSpeed;
			ballReleased = true;
		}
	}

	function update() {
		playerBet.x = game.input.x;

		let playerBetHalf = playerBet.width / 2;

		if (playerBet.x < playerBetHalf) {
			playerBet.x = playerBetHalf;
		} else if (playerBet.x > game.width - playerBetHalf) {
			playerBet.x = game.width - playerBetHalf;
		}

		if(compBet.x - ball.x < -15) {
            compBet.body.velocity.x = computerBetSpeed;
        }
        else if(compBet.x - ball.x > 15) {
            compBet.body.velocity.x = -computerBetSpeed;
        }
        else {
            compBet.body.velocity.x = 0;
        }

				game.physics.arcade.collide(ball, playerBet, ballHitsBet);
        game.physics.arcade.collide(ball, compBet, ballHitsBet);

				function ballHitsBet (_ball, _bet) {
        var diff = 0;

        if (_ball.x < _bet.x) {
            //  Шарик находится с левой стороны ракетки
            diff = _bet.x - _ball.x;
            _ball.body.velocity.x = (-10 * diff);
        }
        else if (_ball.x > _bet.x) {
            //  Шарик находится с правой стороны ракетки
            diff = _ball.x -_bet.x;
            _ball.body.velocity.x = (10 * diff);
        }
        else {
            //  Шарик попал в центр ракетки, добавляем немножко трагической случайности его движению
            _ball.body.velocity.x = 2 + Math.random() * 8;
        }
    }

		function checkGoal() {
        if (ball.y < 20) {
            setBall();
        }
				if (ball.y > 600) {
            setBall();
        }
    }

    function setBall() {
        if (ballReleased) {
            ball.x = game.world.centerX;
            ball.y = game.world.centerY;
            ball.body.velocity.x = 0;
            ball.body.velocity.y = 0;
            ballReleased = false;
        }

    }

		checkGoal();

	}

	function createBet(x, y) {
		let bet = game.add.sprite(x, y, 'bet');
		game.physics.enable(bet);
		bet.anchor.setTo(0.5, 0.5);
		bet.body.collideWorldBounds = true;
		bet.body.bounce.setTo(1, 1);
		bet.body.immovable = true;

		return bet;
	}

	</script>
</body>

</html>
