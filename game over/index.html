<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Circles</title>
	<script type="text/javascript" src="phaser.min.js"></script>
</head>

<body>
	<div id="test"></div>

	<script type="text/javascript">
	var game = new Phaser.Game(1000, 560, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create });


function preload() {
	game.load.bitmapFont('Fira', 'assets/fonts/fira-sans.png', 'assets/fonts/fira-sans.fnt');
	game.load.bitmapFont('Playfair', 'assets/fonts/playfair.png', 'assets/fonts/playfair.fnt');
	game.load.image('outer', 'assets/outer.png');
	game.load.image('center', 'assets/center.png');
	game.load.image('key', 'assets/key.png');
}

function create() {
	game.canvas.oncontextmenu = function (e) { e.preventDefault(); }
	game.stage.backgroundColor = '#f95732';

	title = game.add.bitmapText(10, 10, 'Fira', 'MESSAGE', 50);
	title.tint = 0x000000;

	game.add.sprite(420, game.world.height - 312, 'key');

	textarea = game.add.graphics(0, 0);
	textarea.beginFill(0xffffff);
	textarea.drawRect(10, 100, 420, game.world.height * 0.75);
	textarea.endFill();

	cipheredMessage = 'oauxo ausW oeoine onls wdgsaaahsrirnstldtapdF rdot r yvth   rpiosgeadnre.ke  yOyb e. lno o  e pt u aonaawn.ealaier vulgchplroi sr   oterl te etsftirrt';
	cipheredText = game.add.bitmapText(15, 105, 'Playfair', cipheredMessage, 24);
	cipheredText.maxWidth = 400;
	cipheredText.tint = 0x000000;

	decipheredMessage = 'We are along the road paralell to 276.4. Our own artillery is dropping a barrage directly on us. For heavens sake stop it.';
	decipheredText = game.add.bitmapText(15, 105, 'Playfair', decipheredMessage, 24);
	decipheredText.maxWidth = 400;
	decipheredText.tint = 0x000000;
	decipheredText.alpha = 0;

	let circle1 = createCircle('outer');
	let center =  createCircle('center');

	let digitsBackground = game.add.graphics(0, 0);
	digitsBackground.beginFill(0xeff4dd);
	digitsBackground.drawRect(440, 90, 165, 100);
	digitsBackground.endFill();

	for (let i = 0; i < 4; i++) {
		let back = game.add.graphics(0, 0);
		back.beginFill(0x618a8c);
		back.drawRect(450 + i * 40, 100, 30, 35);
		back.endFill();
	}

	for (let i = 0; i < 4; i++) {
		let back = game.add.graphics(0, 0);
		back.beginFill(0xfb8f6c);
		back.drawRect(450 + i * 40, 150, 30, 35);
		back.endFill();
	}

	cipher1 = createDigit(0, '4');
	cipher2 = createDigit(40, '2');
	cipher3 = createDigit(80, '7');
	cipher3 = createDigit(120, '8');

	counter1 = createCounter(0);
	counter2 = createCounter(40);
	counter3 = createCounter(80);
	counter4 = createCounter(120);

	function createCircle(name) {
		let circle = game.add.sprite(840, 160, name);
		circle.anchor.setTo(0.5, 0.5);
		circle.inputEnabled = true;
		if (name !== 'center') {
				circle.angle = getRandomAngle();
			 circle.events.onInputDown.add(rotateCircle, this);
		}
		return circle;
	}

	function rotateCircle(circle) {
		if (isFinished() === true) {
			circle.angle = circle.angle;
		} else {
			 game.input.mouse.capture = true;
			 if (game.input.activePointer.leftButton.isDown == true) {
				 circle.angle = Math.round(circle.angle + 36);
			} else {
				 circle.angle = Math.round(circle.angle - 36);
			}
			isFinished();
		}
	}

	function createDigit(x, text) {
		let digit = game.add.text(455 + x, 100, text);
		return digit;
	}

	function createCounter(x) {
		let text = game.add.text(455 + x, 150, '0');
		text.counter = Math.floor(Math.random()*10);
		text.text = text.counter.toString();
		text.inputEnabled = true;
		text.events.onInputDown.add(down, this);
		return text;
	}

	function getRandomAngle() {
		let possiblePositions = [36, 72, 144, -180, -144, -108, -72, -36];
		let randomPosition = Math.floor(Math.random() * possiblePositions.length);
		return possiblePositions[randomPosition];
	}

	let isFinished = function() {
		console.log(counter1.counter);
		if (counter1.counter === 8 && counter2.counter === 6 && counter3.counter === 1 && counter4.counter === 2) {
			game.add.tween(cipheredText).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true);
			game.add.tween(decipheredText).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true);
		}
		return (counter1.counter === 8 && counter2.counter === 6 && counter3.counter === 1 && counter4.counter === 2);
	}

	function down(item) {
		(item.counter === 9) ?	item.counter = 0 : item.counter++;
     item.text = item.counter.toString();
	}

}
	</script>
</body>
</html>
